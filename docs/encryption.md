# Encryption

Restorable CLI supports decrypting age-encrypted backups. This guide covers setting up encryption for your backup verification workflow.

## Overview

[Age](https://github.com/FiloSottile/age) is a simple, modern, and secure encryption tool. Restorable uses age to decrypt backups before restoration, keeping your backup data secure at rest.

## Why Age?

- **Simple**: Easy to use with minimal configuration
- **Secure**: Uses modern cryptographic primitives (X25519, ChaCha20-Poly1305)
- **Composable**: Works well with any backup workflow
- **No configuration**: No config files or options to mess up

## Setting Up Encryption

### Step 1: Install Age

```bash
# macOS
brew install age

# Ubuntu/Debian
apt install age

# From source
go install filippo.io/age/cmd/...@latest
```

### Step 2: Generate an Encryption Key

```bash
# Generate a new key pair
age-keygen -o ~/.restorable/keys/backup.key

# Output shows the public key:
# Public key: age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p
```

Save the public key for encrypting backups.

### Step 3: Configure Restorable

Add the encryption section to your config:

```yaml
encryption:
  method: "age"
  private_key_path: "~/.restorable/keys/backup.key"
```

### Step 4: Encrypt Your Backups

In your backup workflow, encrypt backups with the public key:

```bash
# Encrypt a backup
age -r age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p \
    -o backup.dump.age \
    backup.dump

# Or pipe from pg_dump
pg_dump -Fc mydb | age -r age1ql3z... > backup.dump.age
```

## Configuration Reference

```yaml
encryption:
  method: "age"
  private_key_path: "~/.restorable/keys/backup.key"
```

| Key | Type | Required | Description |
|-----|------|----------|-------------|
| `method` | string | Yes | Encryption method. Only `"age"` supported. |
| `private_key_path` | string | Yes | Path to age private key file. |

## Key File Format

Age private keys are plain text files:

```
# created: 2024-01-15T10:30:00Z
# public key: age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p
AGE-SECRET-KEY-1QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ
```

## Complete Encryption Workflow

### Backup Script

```bash
#!/bin/bash
# backup-and-encrypt.sh

set -e

BACKUP_DIR="/var/backups/postgres"
AGE_PUBLIC_KEY="age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p"
DATE=$(date +%Y-%m-%d)

# Create backup
pg_dump -Fc mydb > "${BACKUP_DIR}/backup-${DATE}.dump"

# Encrypt
age -r "$AGE_PUBLIC_KEY" \
    -o "${BACKUP_DIR}/backup-${DATE}.dump.age" \
    "${BACKUP_DIR}/backup-${DATE}.dump"

# Remove unencrypted backup
rm "${BACKUP_DIR}/backup-${DATE}.dump"

# Update latest symlink
ln -sf "backup-${DATE}.dump.age" "${BACKUP_DIR}/latest.dump.age"

echo "Backup complete: ${BACKUP_DIR}/backup-${DATE}.dump.age"
```

### Restorable Configuration

```yaml
backup:
  source: "local"
  local:
    path: "/var/backups/postgres/latest.dump.age"

encryption:
  method: "age"
  private_key_path: "~/.restorable/keys/backup.key"
```

### Verification

```bash
restorable verify
```

Restorable automatically detects the encrypted backup and decrypts it using the configured key.

## S3 with Encrypted Backups

```yaml
backup:
  source: "s3"
  s3:
    endpoint: "https://s3.amazonaws.com"
    bucket: "my-backups"
    region: "us-east-1"
    access_key_env: "AWS_ACCESS_KEY_ID"
    secret_key_env: "AWS_SECRET_ACCESS_KEY"
    prefix: "postgres/production/"

encryption:
  method: "age"
  private_key_path: "~/.restorable/keys/backup.key"
```

## Multiple Recipients

If multiple systems need to decrypt backups, use multiple recipients:

```bash
# Generate keys for each system
age-keygen -o system1.key
age-keygen -o system2.key

# Encrypt for multiple recipients
age -r age1... -r age2... -o backup.dump.age backup.dump
```

Each system can decrypt with its own private key.

## Key Rotation

To rotate encryption keys:

1. Generate a new key pair
2. Update backup scripts to encrypt with both old and new public keys
3. Wait for old backups to age out
4. Update Restorable config with new private key
5. Remove old public key from backup scripts

```bash
# During transition, encrypt for both keys
age -r $OLD_PUBLIC_KEY -r $NEW_PUBLIC_KEY -o backup.dump.age backup.dump
```

## Security Best Practices

### Key Storage

- Store private keys with restrictive permissions: `chmod 600 ~/.restorable/keys/backup.key`
- Never commit private keys to version control
- Consider using a secrets manager for production environments
- Keep backups of your private keys in a secure location

### Key Separation

Use separate keys for:
- **Backup encryption**: Used by backup system to encrypt
- **Report signing**: Used by Restorable to sign reports (generated by `restorable init`)

```
~/.restorable/keys/
├── backup.key      # Age key for decrypting backups
├── signing.key     # Ed25519 key for signing reports
└── signing.pub     # Ed25519 public key for verification
```

### Environment Variable Alternative

For containerized environments, you can load the key from an environment variable. This requires modifying the decryptor initialization in your setup.

## Troubleshooting

### "failed to decrypt"

- Verify the private key matches the public key used for encryption
- Check the private key file format is correct
- Ensure the key file is readable

### "age: error: no identity matched any of the recipients"

- The backup was encrypted with a different public key
- Verify you're using the correct private key

### "permission denied" on key file

```bash
chmod 600 ~/.restorable/keys/backup.key
```

### Testing Decryption Manually

```bash
# Test that your key can decrypt the backup
age -d -i ~/.restorable/keys/backup.key backup.dump.age > /dev/null
echo "Decryption successful"
```

## Disabling Encryption

To use unencrypted backups, simply omit the `encryption` section from your config:

```yaml
backup:
  source: "local"
  local:
    path: "/var/backups/postgres/latest.dump"

# No encryption section = unencrypted backup
```

## Next Steps

- [Backup Sources](backup-sources.md) - Configure backup sources
- [Configuration](configuration.md) - Full configuration reference
- [Getting Started](getting-started.md) - Run your first verification
