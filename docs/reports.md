# Reports

Restorable CLI generates signed verification reports after each run. This document covers report structure, management, and usage for compliance.

## Overview

Reports provide:
- **Proof of verification**: Documented evidence that a backup was restored
- **Audit trail**: Timestamped records for compliance
- **Tamper detection**: Ed25519 signatures ensure integrity
- **Metrics history**: Track database changes over time

## Report Storage

Reports are stored in `~/.restorable/reports/` with the naming convention:

```
{timestamp}_{uuid}.json
```

Example: `2024-01-15T10-30-00Z_abc12345-def6-7890-abcd-ef1234567890.json`

## Report Structure

### JSON Schema

```json
{
  "version": "1",
  "id": "abc12345-def6-7890-abcd-ef1234567890",
  "timestamp": "2024-01-15T10:30:00Z",
  "project_id": "prod-billing-db",
  "project_name": "Production Billing Database",
  "machine_id": "db-verify-01",
  "backup_source": "s3://company-backups/postgres/production/",
  "database": {
    "type": "postgres",
    "version": "15",
    "size_bytes": 268435456
  },
  "schema": {
    "version": "1",
    "timestamp": "2024-01-15T10:30:00Z",
    "tables": [
      {
        "name": "users",
        "schema": "public",
        "column_count": 8,
        "columns": [
          {"name": "id", "data_type": "integer", "nullable": false},
          {"name": "email", "data_type": "text", "nullable": false}
        ]
      }
    ]
  },
  "metrics": {
    "timestamp": "2024-01-15T10:30:00Z",
    "restore_duration_ns": 45000000000,
    "db_size_bytes": 268435456,
    "table_metrics": [
      {"name": "users", "schema": "public", "row_count": 15234}
    ]
  },
  "checks": [
    {
      "name": "tables_exist",
      "level": "critical",
      "passed": true,
      "message": "All 12 baseline tables exist"
    }
  ],
  "summary": {
    "success": true,
    "total_checks": 5,
    "passed_checks": 5,
    "failed_checks": 0,
    "critical_failures": 0,
    "warning_failures": 0,
    "restore_duration": "45s"
  },
  "signature": "base64encodedEd25519signature..."
}
```

### Field Reference

| Field | Type | Description |
|-------|------|-------------|
| `version` | string | Report format version |
| `id` | string | Unique report UUID |
| `timestamp` | string | ISO 8601 UTC timestamp |
| `project_id` | string | Project identifier |
| `project_name` | string | Human-readable project name |
| `machine_id` | string | Verification machine identifier |
| `backup_source` | string | Source identifier (path, S3 URL, etc.) |
| `database` | object | Database type, version, and size |
| `schema` | object | Extracted schema with tables and columns |
| `metrics` | object | Database metrics (size, row counts, duration) |
| `checks` | array | Individual check results |
| `summary` | object | Aggregated check summary |
| `signature` | string | Base64-encoded Ed25519 signature |

## Managing Reports

### List Reports

```bash
restorable report list
```

Output:
```
ID        TIMESTAMP             PROJECT              STATUS
abc123    2024-01-15 10:30:00   Production Database  SUCCESS
def456    2024-01-14 10:30:00   Production Database  SUCCESS
ghi789    2024-01-13 10:30:00   Production Database  FAILURE
```

### View Report Details

```bash
# Human-readable format
restorable report show abc123

# JSON format (for scripting)
restorable report show abc123 --json
```

### Verify Signature

```bash
restorable report verify abc123
```

Output:
```
Signature valid
```

Or on failure:
```
Signature invalid: signature mismatch
```

## Report Signing

### How Signing Works

1. Report JSON is serialized (excluding signature field)
2. Ed25519 private key signs the JSON
3. Signature is base64-encoded and added to report
4. Report is saved with signature included

### Key Files

Generated by `restorable init`:
- `~/.restorable/keys/signing.key` - Private key (64 bytes)
- `~/.restorable/keys/signing.pub` - Public key (32 bytes)

### Verifying Externally

To verify a report signature outside of Restorable:

```go
import (
    "crypto/ed25519"
    "encoding/base64"
    "encoding/json"
)

// Load public key
pubKey, _ := os.ReadFile("~/.restorable/keys/signing.pub")

// Load report
reportJSON, _ := os.ReadFile("report.json")
var report map[string]interface{}
json.Unmarshal(reportJSON, &report)

// Extract and decode signature
sig, _ := base64.StdEncoding.DecodeString(report["signature"].(string))

// Remove signature for verification
delete(report, "signature")
dataToVerify, _ := json.Marshal(report)

// Verify
valid := ed25519.Verify(pubKey, dataToVerify, sig)
```

## Compliance Use Cases

### ISO 27001

**Control A.12.3.1 - Information Backup**

Reports demonstrate:
- Regular backup verification (timestamp evidence)
- Successful restore capability (check results)
- Integrity verification (signed reports)

**Evidence Package:**
```bash
# Export reports for audit
restorable report list > audit_report_list.txt

for id in $(restorable report list | tail -n +2 | awk '{print $1}'); do
    restorable report show $id --json > "reports/${id}.json"
done
```

### SOC 2

**CC6.1 - Logical and Physical Access Controls**

Reports show:
- Machine ID tracking (who ran verification)
- Timestamp evidence (when verification occurred)
- Source tracking (which backup was verified)

### NIS2

**Article 21 - Security Risk Management**

Reports provide:
- Continuous monitoring evidence
- Recovery capability proof
- Incident response readiness

## Report Retention

### Automatic Cleanup

Restorable does not automatically delete old reports. Implement retention policies based on your compliance requirements:

```bash
# Keep last 90 days of reports
find ~/.restorable/reports -name "*.json" -mtime +90 -delete
```

### Archiving

For long-term retention:

```bash
# Archive old reports
tar -czf reports-archive-$(date +%Y-%m).tar.gz ~/.restorable/reports/

# Move to archival storage
aws s3 cp reports-archive-*.tar.gz s3://company-archives/restorable/
```

## Automation and Integration

### Extracting Data

```bash
# Get latest report status
LATEST_ID=$(restorable report list | head -2 | tail -1 | awk '{print $1}')
restorable report show "$LATEST_ID" --json | jq '.summary.success'

# Get restore duration trend
for file in ~/.restorable/reports/*.json; do
    jq -r '[.timestamp, .summary.restore_duration] | @tsv' "$file"
done
```

### Alerting on Failure

```bash
#!/bin/bash
# alert-on-failure.sh

restorable verify
EXIT_CODE=$?

if [ $EXIT_CODE -eq 2 ]; then
    REPORT_ID=$(restorable report list | head -2 | tail -1 | awk '{print $1}')
    
    curl -X POST https://alerts.company.com/webhook \
        -H "Content-Type: application/json" \
        -d "{\"severity\": \"critical\", \"message\": \"Backup verification failed\", \"report_id\": \"$REPORT_ID\"}"
fi
```

### Metrics Export

```bash
# Export to Prometheus pushgateway
REPORT=$(restorable report show latest --json)
SUCCESS=$(echo "$REPORT" | jq '.summary.success | if . then 1 else 0 end')
DURATION=$(echo "$REPORT" | jq '.metrics.restore_duration_ns / 1000000000')
SIZE=$(echo "$REPORT" | jq '.database.size_bytes')

cat <<METRICS | curl --data-binary @- http://pushgateway:9091/metrics/job/restorable
# HELP restorable_verify_success Backup verification success
# TYPE restorable_verify_success gauge
restorable_verify_success $SUCCESS
# HELP restorable_restore_duration_seconds Restore duration
# TYPE restorable_restore_duration_seconds gauge
restorable_restore_duration_seconds $DURATION
# HELP restorable_db_size_bytes Database size
# TYPE restorable_db_size_bytes gauge
restorable_db_size_bytes $SIZE
METRICS
```

## Troubleshooting

### "Report not found"

```bash
# Check report directory
ls ~/.restorable/reports/

# Verify report ID matches
restorable report list
```

### "Signature invalid"

- Report may have been modified
- Wrong public key being used
- Key files may be corrupted

```bash
# Regenerate keys (will invalidate old reports)
restorable init  # Follow prompts to regenerate keys
```

### Reports not being saved

- Check report directory permissions
- Verify disk space available
- Check for errors in verify output

```bash
# Ensure directory exists with correct permissions
mkdir -p ~/.restorable/reports
chmod 755 ~/.restorable/reports
```

## Next Steps

- [Verification Checks](verification-checks.md) - Understanding check results
- [Commands](commands.md) - CLI reference
- [Configuration](configuration.md) - Report directory settings
